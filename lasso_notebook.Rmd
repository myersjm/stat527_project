---
title: "Lasso - Walmart"
output: html_notebook
---

```{r}
# install.packages("tidyverse")
# install.packages("timetk")
library(tidyverse)
library(readr) #read_csv()
library(dplyr)
library(glmnet)
library(caret) # may not need anymore
library(timetk)
```


### 1) Load Data
```{r}
# Load data:
df <- read_csv("./data/walmart/Walmart.csv")
head(df)
```

**Fix Datatypes, Sort Values**
```{r}
# Fixing datatypes:
# any(grepl("/", df$Date))
print(sapply(df, class))
df$Date <- gsub("/", "-", df$Date) # replace slashes with dashes, so all dates follow same format
df$Date <- as.Date(df$Date, format = "%d-%m-%Y") # NOTE european-like date: day/month/year
print(sapply(df, class))

# Sort values:
df <- df[order(df$Date, decreasing = FALSE), ] # gets an ordering of rows based on date and then df[ix] to select that order
head(df)
```
```{r}
print(dim(df))
table(df$Date) # value_counts
```

**There are 45 stores, so this makes sense, that there are 45 entries for each date. Also, each date represents one week.**


**Normalize weekly sales within each store, so that no one store dominates, and weekly sales are comparable:**
i.e. (sales_store - mean(sales_store)) / std(sales_store)
and can convert back later via (scaled_sales * store_std) + store_mean
```{r}
df <- df %>%
  group_by(Store) %>%
  mutate(
    sales_mean = mean(Weekly_Sales, na.rm = TRUE),
    sales_std   = sd(Weekly_Sales, na.rm = TRUE),
    weekly_sales_scaled = (Weekly_Sales - sales_mean) / sales_std
  ) %>%
  ungroup()
head(df)
```

```{r}
for (store_id in 1:length(unique(df$Store))) {
  p <- df %>%
    filter(Store == store_id) %>%
    ggplot(aes(x = Date, y = weekly_sales_scaled)) +
    geom_line(color = "steelblue") +
    labs(title = paste("Weekly Sales Over Time - Store", store_id),
         x = "Date",
         y = "Weekly Sales (scaled per store)")
  print(p)
  }


```

### 2) Train/Test split on sorted data:
```{r}
# Can't randomize the data first, because it is time-series
split_ix <- floor(.8*nrow(df))
train_df <- df[1:split_ix,]
test_df <- df[(split_ix+1):nrow(df),]

print(dim(train_df))
print(dim(test_df))
cat("train:", format(min(train_df$Date), "%Y-%m-%d"), " to ", format(max(train_df$Date), "%Y-%m-%d"),"\n")
cat("test:", format(min(test_df$Date), "%Y-%m-%d"), " to ", format(max(test_df$Date), "%Y-%m-%d"),"\n")

print(colnames(df))
# model.matrix creates a design matrix, auto-encodes categorical as dummy vars (if any--in this case, holiday is already a double.)
# X_train <- model.matrix(weekly_sales_scaled ~ . - Store - Date - Weekly_Sales - sales_mean - sales_std + 0, data=train_df) # + 0 means no intercept
X_test <- model.matrix(weekly_sales_scaled ~ . - Store - Date - Weekly_Sales - sales_mean - sales_std + 0, data=test_df)
# y_train <- train_df$weekly_sales_scaled
y_test <- test_df$weekly_sales_scaled
# NOTE: i just commented out X_train because realized cv function requires dataframe.

print(dim(X_test))
#print(dim(X_train))
#print(X_train[1:10,])
print(X_test[1:10,])
```

### 3) LASSO with Rolling Time-series cross validation
Because, it is important to keep the future in the test, or else it could cheat and 
accidentally learn the past and use it to predict the past, some inherent pattern.
i.e. could use info from the future to predict the past (leakage).

```{r}
cv_folds <- time_series_cv(
  data = train_df,
  date_var = Date,
  cumulative = FALSE, # no growing window (same size folds)
  initial = "6 months", # length of train window
  assess = "3 months", # length of validation window
  skip = "3 months", # jump between folds
  slice_limit = 5 # num folds max
)

plot_time_series_cv_plan(cv_folds, .date_var = Date, .value = weekly_sales_scaled)
```




### Old code----
Set up cross validation folds, for time-series.

```{r}
n_train <- nrow(train_df)
folds <- createTimeSlices(1:n_train, 
                          initialWindow = floor(0.7*n_train), # 70% is train data
                          horizon = floor(0.1*n), # 10% is val data 
                          fixedWindow = TRUE) # do not grow the time slice windows with time--do rolling. 

str(folds$train[1:3])

```


### 4) LASSO - baseline, NO lagged variables.
```{r}

```

